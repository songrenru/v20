(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-38a196f2"],{"3ee1":function(e,t,s){"use strict";s("a3ce")},a3ce:function(e,t,s){},fe13:function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"mt-10 mb-20 mh-full"},[s("a-form-model",e._b({ref:"form",attrs:{model:e.formData,rules:e.rules}},"a-form-model",{labelCol:{span:4},wrapperCol:{span:10}},!1),[s("a-card",{attrs:{title:"基本信息",bordered:!1}},[s("a-form-model-item",{attrs:{label:"活动名称",prop:"name"}},[s("a-input",{attrs:{placeholder:"请输入活动名称",disabled:2==e.formData.status},model:{value:e.formData.name,callback:function(t){e.$set(e.formData,"name",t)},expression:"formData.name"}})],1),s("a-form-model-item",{attrs:{label:"活动时间"}},[s("a-form-model-item",{ref:"startTime",style:{display:"inline-block"},attrs:{prop:"start_time",autoLink:!1}},[s("a-date-picker",{attrs:{disabled:2==e.formData.status||1==e.formData.status,format:"YYYY-MM-DD","disabled-date":e.disabledStartDate,placeholder:"请选择活动开始时间",getCalendarContainer:function(e){return e.parentNode}},on:{change:e.onDateStartChange},model:{value:e.start_time,callback:function(t){e.start_time=t},expression:"start_time"}})],1),s("span",{style:{display:"inline-block",width:"24px",textAlign:"center"}},[e._v(" - ")]),s("a-form-model-item",{ref:"endTime",style:{display:"inline-block"},attrs:{prop:"end_time",autoLink:!1}},[s("a-date-picker",{attrs:{disabled:2==e.formData.status,format:"YYYY-MM-DD","disabled-date":e.disabledEndDate,placeholder:"请选择活动结束时间",getCalendarContainer:function(e){return e.parentNode}},on:{change:e.onDateEndChange},model:{value:e.end_time,callback:function(t){e.end_time=t},expression:"end_time"}})],1)],1)],1),s("a-card",{staticStyle:{"margin-top":"10px"},attrs:{title:"优惠信息",bordered:!1}},[s("a-form-model-item",{attrs:{label:"活动类型",prop:"is_discount"}},[s("a-radio-group",{on:{change:e.isDiscountChange},model:{value:e.formData.is_discount,callback:function(t){e.$set(e.formData,"is_discount",t)},expression:"formData.is_discount"}},[s("a-radio",{attrs:{value:0}},[e._v(" 满减")]),s("a-radio",{attrs:{value:1}},[e._v(" 满折")])],1)],1),e._l(e.formData.rule,(function(t,a){return s("div",{key:t.key},[s("a-form-model-item",{staticStyle:{"margin-bottom":"0"},attrs:{label:"优惠条件","wrapper-col":{span:18},prop:"rule."+a+".level_money",rules:e.rule_detail_rules}},[s("div",[s("span",{staticClass:"mr-10"},[e._v("满足")]),s("a-input-number",{attrs:{min:0},model:{value:t.level_money,callback:function(s){e.$set(t,"level_money",s)},expression:"rule_item.level_money"}}),s("span",{staticClass:"mr-10"},[e._v("元")]),s("span",{staticClass:"ml-10"},[e._v(e._s(0==e.formData.is_discount?"优惠":"折扣"))]),s("a-input-number",{attrs:{min:0},model:{value:t.level_discount,callback:function(s){e.$set(t,"level_discount",s)},expression:"rule_item.level_discount"}}),s("span",{staticClass:"ml-10"},[e._v(e._s(0==e.formData.is_discount?"元":"折"))]),s("a-button",{directives:[{name:"show",rawName:"v-show",value:0==a,expression:"rule_index == 0"}],attrs:{type:"link"},on:{click:function(t){return e.addRuleDetail()}}},[e._v("添加一级")]),s("a-button",{directives:[{name:"show",rawName:"v-show",value:0!=a,expression:"rule_index != 0"}],attrs:{type:"link"},on:{click:function(t){return e.delRuleDetail(a)}}},[e._v("删除")])],1)])],1)})),s("a-form-model-item",{attrs:{label:"限购",prop:"max_num",help:"0代表不限购，请输入0~999正整数"}},[s("span",{staticClass:"mr-10"},[e._v("每人最多可参与")]),s("a-input-number",{attrs:{min:0,max:999},model:{value:e.formData.max_num,callback:function(t){e.$set(e.formData,"max_num",t)},expression:"formData.max_num"}}),s("span",{staticClass:"ml-10"},[e._v("次")])],1),s("a-form-model-item",{attrs:{label:"优惠是否同享",prop:"is_discount_share"}},[s("a-radio-group",{model:{value:e.formData.is_discount_share,callback:function(t){e.$set(e.formData,"is_discount_share",t)},expression:"formData.is_discount_share"}},[s("a-radio",{attrs:{value:1}},[e._v(" 是")]),s("a-radio",{attrs:{value:2}},[e._v(" 否")])],1),1==e.formData.is_discount_share?s("div",[s("a-checkbox-group",{model:{value:e.formData.share_discount,callback:function(t){e.$set(e.formData,"share_discount",t)},expression:"formData.share_discount"}},[s("a-checkbox",{attrs:{value:"1"}},[e._v(" 商家会员卡")]),s("a-checkbox",{attrs:{value:"2"}},[e._v(" 商家优惠券")])],1)],1):e._e()],1),s("a-form-model-item",{attrs:{label:"活动商品",prop:"act_type"}},[s("a-radio-group",{model:{value:e.formData.act_type,callback:function(t){e.$set(e.formData,"act_type",t)},expression:"formData.act_type"}},[s("a-radio",{attrs:{value:1}},[e._v(" 全店商品参与")]),s("a-radio",{attrs:{value:0}},[e._v(" 部分商品参与")])],1)],1),0==e.formData.act_type?s("a-form-model-item",{attrs:{"wrapper-col":{span:20,offset:4}}},[s("a-button",{attrs:{type:"primary"},on:{click:function(t){return e.addProduct()}}},[e._v(" 添加商品")]),e.selectedRowKeys.length?s("a-button",{staticClass:"ml-20",attrs:{type:"danger"},on:{click:function(t){return e.removeGoods()}}},[e._v(" 删除 "+e._s(e.selectedRowKeys.length)+" 项 ")]):e._e(),s("a-table",{directives:[{name:"show",rawName:"v-show",value:e.goodsList.length,expression:"goodsList.length"}],staticClass:"mt-20",attrs:{"row-selection":e.rowSelection,columns:e.columns,"data-source":e.goodsList,rowKey:"goods_id",scroll:{x:!1}},scopedSlots:e._u([{key:"name",fn:function(t,a){return s("span",{},[s("div",{staticClass:"product-info"},[s("div",[s("img",{attrs:{src:a.image}})]),s("div",[e._v(e._s(t))])])])}},{key:"price",fn:function(t,a){return s("span",{staticClass:"cr-red"},[s("span",[e._v("￥"+e._s(a.min_price)+" ~ ￥"+e._s(a.max_price))])])}},{key:"action",fn:function(t){return s("span",{},[s("a",{staticClass:"ml-10 inline-block",on:{click:function(s){return e.removeGoods(t)}}},[e._v("删除")])])}}],null,!1,4275358666)})],1):e._e()],2),2!=e.formData.status?s("a-form-model-item",{attrs:{"wrapper-col":{span:16,offset:2}}},[s("div",{staticClass:"mt-20 mb-20"},[s("a-button",{attrs:{type:"primary"},on:{click:function(t){return e.saveData()}}},[e._v(" 保存")])],1)]):e._e()],1),s("select-goods",{ref:"selectGoods",attrs:{storeId:e.store_id,source:"minus_discount",startTime:e.formData.start_time,endTime:e.formData.end_time,selectedList:e.goodsList},on:{submit:e.selecrGoodsSubmit}})],1)},o=[],i=(s("a434"),s("d3b7"),s("159b"),s("4e82"),s("25f0"),s("4031")),r=s("c1df"),n=s.n(r),l=s("37fd"),c=s("ca00"),d=s("ac0d"),u={name:"MinusDiscountEdit",mixins:[d["d"]],components:{SelectGoods:l["default"]},data:function(){return{store_id:"",id:"",addGoodsModalVisible:!1,pagination:{total:0,pageSize:10,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:function(e){return"共 ".concat(e," 条记录")}},formData:{name:"",start_time:"",end_time:"",is_discount:0,max_num:0,is_discount_share:1,share_discount:["1","2"],act_type:1,rule:[{level_sort:1,level_money:"",level_discount:""}]},rules:{name:[{required:!0,message:"请输入活动名称",trigger:"blur"}],start_time:[{required:!0,message:"请选择活动开始时间",trigger:["blur","change"]}],end_time:[{required:!0,message:"请选择活动结束时间",trigger:["blur","change"]}],nums:[{required:!0,message:"请选择满包邮条件",trigger:"blur"}],max_num:[{required:!0,message:"请选择限购数量",trigger:"blur"}],is_discount_share:[{required:!0,message:"请选择优惠是否同享",trigger:"blur"}],act_type:[{required:!0,message:"请选择活动商品",trigger:"blur"}]},columns:[{title:"商品信息",dataIndex:"name",scopedSlots:{customRender:"name"}},{title:"价格",dataIndex:"price",scopedSlots:{customRender:"price"},width:"200px"},{title:"当前库存",dataIndex:"stock_num"},{title:"操作",dataIndex:"goods_id",width:"100px",scopedSlots:{customRender:"action"}}],goodsList:[],selectedRowKeys:[],rule_detail_rules:[{required:!0,message:"请输入优惠条件",trigger:"blur"}],start_time:null,end_time:null}},watch:{"$route.query.store_id":function(e){e&&(this.store_id=e,this.resetForm())},"$route.query.id":function(e){var t=this;this.$nextTick((function(){t.activatedFlag&&e?(t.id=e,t.resetForm(),t.getFormData()):(t.id="",t.resetForm())}))}},computed:{rowSelection:function(){return{selectedRowKeys:this.selectedRowKeys,type:"checkbox",onChange:this.onSelectChange,getCheckboxProps:function(e){return{props:{}}}}}},created:function(){this.store_id=this.$route.query.store_id,this.resetForm(),this.$route.query.id&&(this.id=this.$route.query.id,this.getFormData())},methods:{moment:n.a,disabledStartDate:function(e){return e<n()().add(-1,"d")},disabledEndDate:function(e){var t=this.start_time;return t?t.valueOf()>=e.valueOf():e<n()().add(-1,"d")},onDateStartChange:function(e,t){this.$set(this.formData,"start_time",t),this.$refs.startTime.onFieldChange()},onDateEndChange:function(e,t){var s=n()(this.formData.start_time).valueOf(),a=n()(t).valueOf();console.log("1-----------活动结束时间选择"),console.log(s),console.log(a),a<s?this.$message.error("活动结束时间必须大于活动开始时间！"):(this.$set(this.formData,"end_time",t),this.$refs.endTime.onFieldChange())},getFormData:function(){var e=this;this.request(i["a"].getMinusDiscountInfo,{id:this.id}).then((function(t){console.log(t),e.start_time=n()(t.start_time),e.end_time=n()(t.end_time),1==t.is_discount_share&&(t.share_discount=[],1==t.discount_card&&t.share_discount.push("1"),1==t.discount_coupon&&t.share_discount.push("2")),e.$set(e,"formData",t),e.goodsList=t.goods_info}))},onDateRangeChange:function(e,t){this.$set(this.formData,"time",[e[0],e[1]]),this.$set(this.formData,"start_time",t[0]),this.$set(this.formData,"end_time",t[1])},addProduct:function(){this.start_time&&this.end_time?this.$refs.selectGoods.openDialog():this.$message.error("请先选择活动时间！")},selecrGoodsSubmit:function(e){console.log(e),this.goodsList=e.goods,this.$set(this.pagination,"total",this.goodsList.length)},isDiscountChange:function(){this.formData.rule=[{level_sort:1,level_money:"",level_discount:""}]},onSelectChange:function(e){this.selectedRowKeys=e},removeGoods:function(e){var t=this;if(e){for(var s=0;s<this.goodsList.length;s++)if(this.goodsList[s].goods_id==e)return this.goodsList.splice(s,1),this.selectedRowKeys.forEach((function(s,a){s==e&&t.selectedRowKeys.splice(a,1)})),void console.log(this.selectedRowKeys)}else this.selectedRowKeys.forEach((function(e,s){t.goodsList.forEach((function(s,a){s.goods_id==e&&t.goodsList.splice(a,1)}))})),this.selectedRowKeys=[],console.log(this.selectedRowKeys)},resetForm:function(){this.formData=this.$options.data().formData,this.start_time=this.$options.data().start_time,this.end_time=this.$options.data().end_time,this.goodsList=[],this.$forceUpdate()},addRuleDetail:function(){if(5!=this.formData.rule.length){var e=this.formData.rule[this.formData.rule.length-1]&&this.formData.rule[this.formData.rule.length-1].level_sort?this.formData.rule[this.formData.rule.length-1].level_sort+1:1,t={level_sort:e,level_money:"",level_discount:""};this.formData.rule.push(t)}else this.$message.error("最多可添加5级")},delRuleDetail:function(e){this.formData.rule.splice(e,1)},saveData:function(){var e=this;this.$refs.form.validate((function(t){if(!t)return console.log("error submit!!",e.formData),!1;var s={};for(var a in e.formData)s[a]=e.formData[a];try{if(!s.rule||!s.rule.length)throw"请输入优惠条件";s.rule.forEach((function(e){if(""==e.level_money)throw"请输入优惠条件";if(0==s.is_discount&&""==e.level_discount)throw"请输入优惠条件";if(1==s.is_discount&&""==e.level_discount)throw"请输入优惠条件";if(0==s.is_discount&&e.level_money<e.level_discount)throw"优惠金额不能大于满足金额";if(1==s.is_discount&&e.level_discount>100)throw"折扣范围0-100之间"}))}catch(d){return void e.$message.error(d)}var o=[];s.rule.forEach((function(e){var t={level_sort:e.level_sort,level_money:e.level_money,level_discount:e.level_discount};o.push(t)}));var r=o.sort(Object(c["a"])("level_money",1));try{r.forEach((function(e,t){if(t+1!=e.level_sort)throw"满足金额层级应为递增"}))}catch(d){return void e.$message.error(d)}if(0==s.is_discount){var n=o.sort(Object(c["a"])("level_discount",1));try{n.forEach((function(e,t){if(t+1!=e.level_sort)throw"优惠金额层级应为递增"}))}catch(d){return void e.$message.error(d)}}else{var l=o.sort(Object(c["a"])("level_discount",2));try{l.forEach((function(e,t){if(t+1!=e.level_sort)throw"优惠折扣层级应为递减"}))}catch(d){return void e.$message.error(d)}}1==s.is_discount_share&&(s.discount_card=0,s.discount_coupon=0,s.share_discount.forEach((function(e){1==e?s.discount_card=1:2==e&&(s.discount_coupon=1)}))),s.store_id=e.store_id,e.id&&(s.id=e.id),s.rule&&(s.rule=JSON.stringify(s.rule)),0!=s.act_type||e.goodsList.length?(s.goods_ids=[],0==s.act_type&&e.goodsList.length&&e.goodsList.forEach((function(e){s.goods_ids.push(e.goods_id)})),s.goods_ids=s.goods_ids.toString(),delete s.share_discount,e.request(i["a"].updateMinusDiscount,s).then((function(t){e.resetForm(),e.$message.success("提交成功！"),e.$router.push({path:"/merchant/merchant.mall/minusDiscountList",query:{store_id:e.store_id}}),sessionStorage.setItem("minusDiscountEdit",1)}))):e.$message.error("请选择活动商品")}))}}},m=u,_=(s("3ee1"),s("0c7c")),f=Object(_["a"])(m,a,o,!1,null,"c531f07e",null);t["default"]=f.exports}}]);